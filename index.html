<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VaComoPi√±a ‚Äì Pedido</title>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#111318;
      --muted:#9aa3b2;
      --text:#e9edf5;
      --line:#232733;
      --accent:#22c55e;
      --danger:#ef4444;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#07080b 0%, #0b0c10 100%);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 90px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .brand h1{font-size:22px;margin:0}
    .brand p{margin:4px 0 0;color:var(--muted);font-size:13px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:8px 12px;border-radius:999px;
      color:var(--muted);font-size:12px;white-space:nowrap
    }
    .layout{display:grid;grid-template-columns:1.35fr .65fr;gap:14px;align-items:start}
    @media (max-width: 940px){.layout{grid-template-columns:1fr}.cart{position:relative;top:0}}
    .card{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden
    }
    .cardHead{
      padding:14px 14px 12px;border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;gap:10px
    }
    .cardHead .title{display:flex;flex-direction:column;gap:4px}
    .cardHead h2{margin:0;font-size:16px}
    .cardHead .sub{margin:0;color:var(--muted);font-size:12px;line-height:1.3}
    .content{padding:14px}
    .progress{display:flex;gap:8px;align-items:center}
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.16);border:1px solid var(--line)}
    .dot.on{background:var(--accent);border-color:rgba(34,197,94,.6)}
    .stepTag{color:var(--muted);font-size:12px}
    .step{display:none}
    .step.active{display:block;animation:fadeIn .18s ease-out}
    @keyframes fadeIn{from{opacity:.2;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    label{display:block;margin:12px 0 6px;font-weight:650;font-size:13px}
    input, select, textarea{
      width:100%;padding:12px 12px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;font-size:14px
    }
    textarea{resize:vertical}
    .muted{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.35}
    .prodCard{
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      border-radius:14px;padding:12px;margin-top:10px
    }
    .prodRow{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .prodRow .name{font-weight:750}
    .price{color:var(--muted);font-size:12px}
    .qtyRow{display:grid;grid-template-columns:1fr 160px;gap:10px;align-items:end;margin-top:10px}
    @media (max-width:520px){.qtyRow{grid-template-columns:1fr}}
    .flavorList{display:grid;gap:10px;margin-top:10px}
    .flavorItem{
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:14px;
      padding:10px;
      display:grid;
      grid-template-columns:1fr 120px;
      gap:10px;
      align-items:center
    }
    .flavorItem .fn{font-weight:650;font-size:13px;line-height:1.25}
    .flavorItem .hint{color:var(--muted);font-size:11px;margin-top:4px}
    .alert{
      margin-top:10px;padding:10px 12px;border-radius:14px;
      border:1px solid rgba(239,68,68,.35);
      background:rgba(239,68,68,.08);
      color:#ffd2d2;font-size:12px;display:none
    }
    .ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.08);color:#d2ffe3}
    .bottomBar{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(10,11,15,.86);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--line);
      padding:10px 14px;z-index:50
    }
    .barInner{
      max-width:1100px;margin:0 auto;
      display:flex;gap:10px;align-items:center;justify-content:space-between
    }
    .barLeft{display:flex;flex-direction:column;gap:2px}
    .barLeft .big{font-weight:800}
    .barLeft .small{color:var(--muted);font-size:12px}
    .barBtns{display:flex;gap:10px;align-items:center}
    button{
      border:0;cursor:pointer;border-radius:14px;padding:12px 14px;
      font-weight:750;font-size:14px
    }
    .btnGhost{background:rgba(255,255,255,.06);color:var(--text);border:1px solid var(--line)}
    .btnPrimary{background:var(--accent);color:#04120a}
    .btnDanger{background:rgba(239,68,68,.16);color:#ffd2d2;border:1px solid rgba(239,68,68,.35)}
    .btnDisabled{opacity:.45;cursor:not-allowed}
    .cart{position:sticky;top:14px}
    .cartBody{padding:14px}
    .cartEmpty{color:var(--muted);font-size:13px;padding:6px 0 2px}
    .cartList{display:grid;gap:10px;margin-top:10px}
    .cartItem{
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      border-radius:14px;padding:10px
    }
    .cartItemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .cartItemTop .cn{font-weight:750;font-size:13px}
    .cartItemTop .cp{color:var(--muted);font-size:12px}
    .cartItemSmall{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.35;white-space:pre-wrap}
    .cartRowEdit{
      display:grid;grid-template-columns:1fr 110px;gap:10px;align-items:center;margin-top:8px
    }
    .cartRowEdit input{padding:10px;border-radius:12px}
    .cartItemActions{display:flex;justify-content:space-between;gap:10px;margin-top:10px}
    .cartItemActions button{padding:8px 10px;border-radius:12px;font-size:12px;font-weight:750}
    .totals{
      border-top:1px solid var(--line);
      margin-top:12px;padding-top:12px;
      display:flex;justify-content:space-between;align-items:center
    }
    .totals .tLabel{color:var(--muted);font-size:12px}
    .totals .tVal{font-weight:900;font-size:16px}
    .mini{color:var(--muted);font-size:11px;margin-top:8px;line-height:1.3}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:520px){.row2{grid-template-columns:1fr}}
    .check{
      display:flex;gap:10px;align-items:flex-start;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      border-radius:14px;
      padding:10px;margin-top:10px
    }
    .check input{width:18px;height:18px;margin-top:2px}
    .check .ct{font-size:13px;font-weight:700}
    .check .cs{font-size:12px;color:var(--muted);margin-top:3px;line-height:1.3}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>ü•™ VaComoPi√±a</h1>
        <p>Pedido estilo app (piloto). Se env√≠a por WhatsApp.</p>
      </div>
      <div class="pill">üìç Ciudadela</div>
    </header>

    <div class="layout">
      <!-- Main -->
      <div class="card">
        <div class="cardHead">
          <div class="title">
            <h2 id="stepTitle">Paso 1: Eleg√≠ el producto</h2>
            <p class="sub" id="stepSub">Seleccion√° el tipo de producto para configurar cantidad y opciones.</p>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
            <div class="progress" aria-hidden="true">
              <span class="dot on" id="dot1"></span>
              <span class="dot" id="dot2"></span>
              <span class="dot" id="dot3"></span>
            </div>
            <div class="stepTag" id="stepTag">1 de 3</div>
          </div>
        </div>

        <div class="content">
          <!-- STEP 1 -->
          <div class="step active" id="step1">
            <label>Producto</label>
            <select id="productSelect">
              <option value="" selected>Seleccionar‚Ä¶</option>
              <option value="clasicos">Triples cl√°sicos (docena) ‚Äî $26.000</option>
              <option value="especiales">Triples especiales (docena) ‚Äî $30.000</option>
              <option value="viandas">Viandas (pack de 7) ‚Äî $59.000</option>
            </select>
            <p class="muted">Pod√©s cargar un producto, agregar al carrito, volver a este paso y cargar otro.</p>
            <div class="alert" id="step1Alert"></div>
          </div>

          <!-- STEP 2 -->
          <div class="step" id="step2">
            <div id="productConfig"></div>
            <div class="alert" id="step2Alert"></div>
          </div>

          <!-- STEP 3 -->
          <div class="step" id="step3">
            <label>¬øRetiro o env√≠o?</label>
            <select id="modoEntrega">
              <option value="retiro" selected>Retiro (coordinamos por WhatsApp)</option>
              <option value="envio">Env√≠o</option>
            </select>

            <div id="envioFields" style="display:none;">
              <label>üìç Direcci√≥n completa</label>
              <input id="direccion" type="text" placeholder="Calle, n√∫mero, piso/depto, entre calles" />

              <label>üìè ¬øM√°s de 3 km desde Ciudadela?</label>
              <select id="mas3km">
                <option value="NO" selected>NO</option>
                <option value="SI">SI</option>
              </select>

              <p class="muted">
                Env√≠o: gratis hasta 3 km ¬∑ $5.000 fuera de ese radio ¬∑ gratis en compras &gt; $100.000 (se confirma por WhatsApp).
              </p>
            </div>

            <div class="check">
              <input id="chk100k" type="checkbox" />
              <div>
                <div class="ct">Compra mayor a $100.000 ‚áí env√≠o gratis</div>
                <div class="cs">Informativo. Se confirma por WhatsApp seg√∫n total y distancia.</div>
              </div>
            </div>

            <label>üí≥ Forma de pago</label>
            <select id="pago">
              <option value="Mercado Pago" selected>Mercado Pago</option>
              <option value="Efectivo">Efectivo</option>
            </select>

            <div class="alert" id="step3Alert"></div>
          </div>
        </div>
      </div>

      <!-- Cart -->
      <div class="card cart">
        <div class="cardHead">
          <div class="title">
            <h2>Carrito</h2>
            <p class="sub">Edit√° cantidades, quit√° √≠tems o vaci√° el carrito.</p>
          </div>
        </div>

        <div class="cartBody">
          <button id="btnClearCart" class="btnGhost" type="button" style="width:100%;">Vaciar carrito</button>

          <div id="cartEmpty" class="cartEmpty" style="margin-top:10px;">Todav√≠a no agregaste productos.</div>
          <div id="cartList" class="cartList"></div>

          <div class="totals">
            <div>
              <div class="tLabel">Total estimado</div>
              <div class="mini">Sin env√≠o (se confirma seg√∫n distancia/total).</div>
            </div>
            <div class="tVal" id="cartTotal">$0</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom bar -->
  <div class="bottomBar">
    <div class="barInner">
      <div class="barLeft">
        <div class="big" id="barMain">Listo para empezar</div>
        <div class="small" id="barSub">Eleg√≠ un producto y avanz√°.</div>
      </div>
      <div class="barBtns">
        <button class="btnGhost" id="btnBack">Volver</button>
        <button class="btnPrimary" id="btnNext">Siguiente</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const WA = "5491164876213";

    const PRICES = {
      clasicos: 26000,
      especiales: 30000,
      viandasPack: 59000
    };

    const VIANDAS = [
      "Empanadas de jam√≥n, queso tybo, muzarela, cebolla y un toque de Roquefort",
      "Churrasquitos de pollo con arroz integral y vegetales",
      "Tapa de asado al horno con bombas de papa y muzarela",
      "Espaguetis integrales con verduras y carne",
      "Pollo a la portuguesa con arroz amarillo",
      "Suprema napolitana con milhojas de papa",
      "1/4 de pollo al horno con papa, batata y cebolla"
    ];

    const SABORES = {
      clasicos: ["Jam√≥n y queso", "Jam√≥n y tomate", "Jam√≥n y huevo"],
      especiales: ["Jam√≥n crudo, r√∫cula y parmesano", "At√∫n, huevo y queso", "C√©sar (pollo parmesano y lechuga)", "Capresse (queso, tomate y albahaca)"]
    };

    // ===== State =====
    let step = 1;

    // cart items:
    // {type, name, qty, unitPrice, details, meta}
    // meta for sandwiches: {flavors:[{name,q}]}
    const cart = [];

    const draft = {
      product: "",
      qty: 0,
      flavors: [], // for sandwiches
      viandas: Array(VIANDAS.length).fill(0),
      notes: ""
    };

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    const money = (n) => "$" + (Number(n)||0).toLocaleString("es-AR");
    const clampInt = (v) => {
      const n = Number(v);
      if (!Number.isFinite(n) || n < 0) return 0;
      return Math.floor(n);
    };

    function setAlert(id, msg, ok=false){
      const el = $(id);
      if (!msg){
        el.style.display = "none";
        el.textContent = "";
        el.classList.remove("ok");
        return;
      }
      el.style.display = "block";
      el.textContent = msg;
      el.classList.toggle("ok", !!ok);
    }

    function updateHeader(){
      const titles = {
        1: ["Paso 1: Eleg√≠ el producto", "Seleccion√° el tipo de producto para configurar cantidad y opciones."],
        2: ["Paso 2: Configur√° y agreg√° al carrito", "Eleg√≠ cantidad/opciones y agreg√° el producto al carrito."],
        3: ["Paso 3: Entrega y pago", "Eleg√≠ retiro/env√≠o y complet√° datos para enviar el pedido."]
      };
      $("stepTitle").textContent = titles[step][0];
      $("stepSub").textContent = titles[step][1];
      $("stepTag").textContent = `${step} de 3`;
      $("dot1").classList.toggle("on", step>=1);
      $("dot2").classList.toggle("on", step>=2);
      $("dot3").classList.toggle("on", step>=3);
    }

    function showStep(n){
      step = n;
      ["step1","step2","step3"].forEach((sid,i)=>{
        $(sid).classList.toggle("active", (i+1)===step);
      });

      if (step === 1){
        $("barMain").textContent = "Eleg√≠ un producto";
        $("barSub").textContent = "Despu√©s configur√°s cantidad y lo agreg√°s al carrito.";
        $("btnBack").classList.add("btnDisabled");
        $("btnBack").disabled = true;
        $("btnNext").textContent = "Siguiente";
        $("btnNext").classList.remove("btnDanger");
      }
      if (step === 2){
        $("barMain").textContent = cart.length ? "Pod√©s agregar m√°s productos" : "Configur√° el producto";
        $("barSub").textContent = "Agregalo al carrito. Luego pod√©s ir a pagar.";
        $("btnBack").classList.remove("btnDisabled");
        $("btnBack").disabled = false;
        $("btnNext").textContent = "Ir a pagar";
        $("btnNext").classList.remove("btnDanger");
      }
      if (step === 3){
        $("barMain").textContent = "Confirm√° y ped√≠";
        $("barSub").textContent = "Se abrir√° WhatsApp con el pedido armado.";
        $("btnBack").classList.remove("btnDisabled");
        $("btnBack").disabled = false;
        $("btnNext").textContent = "Pedir";
        $("btnNext").classList.add("btnDanger");
      }

      updateHeader();
    }

    function cartTotal(){
      return cart.reduce((acc,it)=>acc + it.qty*it.unitPrice, 0);
    }

    function normalizeQtyInCart(idx, newQty){
      const q = clampInt(newQty);
      if (q <= 0){
        cart.splice(idx,1);
      } else {
        cart[idx].qty = q;
        // Si es sandwich, la validaci√≥n de sabores es por docena:
        // - guardamos la selecci√≥n por docena, y el detalle refleja qty docenas.
        // No revalidamos sabores ac√° (se asume "por docena" y escala).
      }
      renderCart();
    }

    function renderCart(){
      const list = $("cartList");
      const empty = $("cartEmpty");
      list.innerHTML = "";

      if (!cart.length){
        empty.style.display = "block";
      } else {
        empty.style.display = "none";
      }

      cart.forEach((it, idx)=>{
        const div = document.createElement("div");
        div.className = "cartItem";

        div.innerHTML = `
          <div class="cartItemTop">
            <div>
              <div class="cn">${it.name}</div>
              <div class="cp">${money(it.unitPrice)} c/u</div>
            </div>
            <div class="cp"><strong>${money(it.qty*it.unitPrice)}</strong></div>
          </div>

          <div class="cartRowEdit">
            <div class="cp">Cantidad</div>
            <input type="number" min="1" value="${it.qty}" data-qty="${idx}" />
          </div>

          ${it.details ? `<div class="cartItemSmall">${it.details}</div>` : ``}

          <div class="cartItemActions">
            <button class="btnGhost" type="button" data-remove="${idx}">Quitar</button>
            <button class="btnDanger" type="button" data-remove="${idx}">Eliminar</button>
          </div>
        `;
        list.appendChild(div);
      });

      $("cartTotal").textContent = money(cartTotal());

      // qty edit
      list.querySelectorAll("input[data-qty]").forEach(inp=>{
        inp.addEventListener("input", ()=>{
          const idx = Number(inp.dataset.qty);
          let val = clampInt(inp.value);
          if (val < 1) val = 1;
          inp.value = val;
          normalizeQtyInCart(idx, val);
        });
      });

      // remove
      list.querySelectorAll("button[data-remove]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const i = Number(btn.dataset.remove);
          cart.splice(i,1);
          renderCart();
          if (step === 2) $("barMain").textContent = cart.length ? "Pod√©s agregar m√°s productos" : "Configur√° el producto";
        });
      });
    }

    $("btnClearCart").addEventListener("click", ()=>{
      cart.length = 0;
      renderCart();
      setAlert("step2Alert","");
      setAlert("step3Alert","");
      if (step === 2) $("barMain").textContent = "Configur√° el producto";
    });

    // ===== Step 1 =====
    $("productSelect").addEventListener("change", ()=>{
      draft.product = $("productSelect").value;
      setAlert("step1Alert", "");
    });

    function validateStep1(){
      if (!draft.product){
        setAlert("step1Alert", "Eleg√≠ un producto para continuar.");
        return false;
      }
      return true;
    }

    function resetDraftForProduct(p){
      draft.product = p;
      draft.qty = 0;
      draft.flavors = [];
      draft.notes = "";
      draft.viandas = Array(VIANDAS.length).fill(0);
    }

    // ===== Step 2 UI =====
    function renderStep2(){
      const p = draft.product;
      const host = $("productConfig");
      host.innerHTML = "";
      setAlert("step2Alert","");

      if (!p){
        host.innerHTML = `<p class="muted">Eleg√≠ un producto en el paso 1.</p>`;
        return;
      }

      const box = document.createElement("div");
      box.className = "prodCard";

      if (p === "clasicos" || p === "especiales"){
        const name = (p==="clasicos") ? "Triples cl√°sicos (docena)" : "Triples especiales (docena)";
        const unit = (p==="clasicos") ? PRICES.clasicos : PRICES.especiales;
        const sabores = SABORES[p];

        box.innerHTML = `
          <div class="prodRow">
            <div>
              <div class="name">${name}</div>
              <div class="muted">Eleg√≠ cu√°ntos de cada sabor. Deben sumar 12 por docena.</div>
            </div>
            <div class="price">${money(unit)} c/u</div>
          </div>

          <div class="qtyRow">
            <div>
              <label>Docenas (cantidad)</label>
              <input id="sandQty" type="number" min="1" value="1" />
              <div class="muted">Ej: 2 docenas ‚áí el total de sabores debe sumar 24.</div>
            </div>
            <div>
              <label>Total requerido</label>
              <input id="sandNeed" type="text" value="12" disabled />
            </div>
          </div>

          <div class="flavorList" id="flavorList"></div>

          <div class="row2">
            <div>
              <label>Notas (opcional)</label>
              <textarea id="sandNotes" rows="3" placeholder="Ej: si pueden surtido, sino reemplazar por jam√≥n y queso."></textarea>
            </div>
            <div>
              <label>Total seleccionado</label>
              <input id="sandPicked" type="text" value="0" disabled />
              <div class="muted" id="sandStatus"></div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <button id="addToCart" class="btnPrimary" type="button" style="width:100%;">Agregar al carrito</button>
            <p class="muted" style="margin:10px 0 0;">Pod√©s volver al paso 1 para agregar otro producto.</p>
          </div>
        `;
        host.appendChild(box);

        // render flavors
        const list = $("flavorList");
        sabores.forEach((s,i)=>{
          const item = document.createElement("div");
          item.className = "flavorItem";
          item.innerHTML = `
            <div>
              <div class="fn">${s}</div>
              <div class="hint">Cantidad</div>
            </div>
            <div>
              <input id="f_${i}" type="number" min="0" value="0" />
            </div>
          `;
          list.appendChild(item);
        });

        function getQtyDocenas(){
          let q = clampInt($("sandQty").value);
          if (q < 1) q = 1;
          $("sandQty").value = q;
          return q;
        }

        function needTotal(){
          return getQtyDocenas() * 12;
        }

        function pickedTotal(){
          let s = 0;
          sabores.forEach((_,i)=> s += clampInt($("f_"+i).value));
          return s;
        }

        function updateSandCounters(){
          const need = needTotal();
          $("sandNeed").value = String(need);
          const picked = pickedTotal();
          $("sandPicked").value = String(picked);

          const st = $("sandStatus");
          if (picked < need){
            st.textContent = `Te faltan ${need - picked}.`;
            st.style.color = "var(--danger)";
          } else if (picked > need){
            st.textContent = `Te pasaste por ${picked - need}. Ajust√° cantidades.`;
            st.style.color = "var(--danger)";
          } else {
            st.textContent = "Selecci√≥n completa ‚úÖ";
            st.style.color = "var(--accent)";
          }
        }

        $("sandQty").addEventListener("input", updateSandCounters);
        sabores.forEach((_,i)=>{
          const inp = $("f_"+i);
          inp.addEventListener("input", ()=>{
            inp.value = clampInt(inp.value);
            updateSandCounters();
          });
        });
        updateSandCounters();

        $("addToCart").addEventListener("click", ()=>{
          const qtyDoc = getQtyDocenas();
          const need = qtyDoc * 12;
          const picked = pickedTotal();
          if (picked !== need){
            setAlert("step2Alert", `Para ${qtyDoc} docena(s) ten√©s que seleccionar exactamente ${need} s√°ndwiches en total.`);
            return;
          }

          const lines = [];
          sabores.forEach((s,i)=>{
            const q = clampInt($("f_"+i).value);
            if (q>0) lines.push(`- ${q}√ó ${s}`);
          });

          const notes = ($("sandNotes").value || "").trim();
          const details = `Sabores:\n${lines.join("\n")}` + (notes ? `\nNotas: ${notes}` : "");

          cart.push({
            type: p,
            name,
            qty: qtyDoc,
            unitPrice: unit,
            details,
            meta: { flavors: lines }
          });

          renderCart();

          // reset selection
          $("sandQty").value = 1;
          sabores.forEach((_,i)=> $("f_"+i).value = 0);
          $("sandNotes").value = "";
          updateSandCounters();
          setAlert("step2Alert", "Agregado al carrito ‚úÖ", true);
        });
      }

      if (p === "viandas"){
        box.innerHTML = `
          <div class="prodRow">
            <div>
              <div class="name">Viandas (pack de 7)</div>
              <div class="muted">Eleg√≠ 7 viandas en total. M√°ximo 3 de la misma variante.</div>
            </div>
            <div class="price">${money(PRICES.viandasPack)} el pack</div>
          </div>

          <div class="flavorList" id="viList"></div>

          <div class="row2">
            <div>
              <label>Notas (opcional)</label>
              <textarea id="viNotes" rows="3" placeholder="Ej: sin cebolla / para freezer / etc."></textarea>
            </div>
            <div>
              <label>Contador</label>
              <input id="viPicked" type="text" value="0/7" disabled />
              <div class="muted" id="viStatus"></div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <button id="addToCart" class="btnPrimary" type="button" style="width:100%;">Agregar al carrito</button>
            <p class="muted" style="margin:10px 0 0;">Pod√©s volver al paso 1 para agregar otro producto.</p>
          </div>
        `;
        host.appendChild(box);

        const list = $("viList");
        VIANDAS.forEach((name,i)=>{
          const item = document.createElement("div");
          item.className = "flavorItem";
          item.innerHTML = `
            <div>
              <div class="fn">${name}</div>
              <div class="hint">M√°ximo 3</div>
            </div>
            <div>
              <input id="v_${i}" type="number" min="0" max="3" value="0" />
            </div>
          `;
          list.appendChild(item);
        });

        function viPicked(){
          let s = 0;
          for (let i=0;i<VIANDAS.length;i++){
            s += clampInt($("v_"+i).value);
          }
          return s;
        }

        function updateViCounter(){
          const picked = viPicked();
          $("viPicked").value = `${picked}/7`;
          const st = $("viStatus");
          if (picked < 7){
            st.textContent = `Te faltan ${7-picked}.`;
            st.style.color = "var(--danger)";
          } else if (picked > 7){
            st.textContent = `Te pasaste por ${picked-7}. Ajust√° cantidades.`;
            st.style.color = "var(--danger)";
          } else {
            st.textContent = "Selecci√≥n completa ‚úÖ";
            st.style.color = "var(--accent)";
          }
        }

        for (let i=0;i<VIANDAS.length;i++){
          const inp = $("v_"+i);
          inp.addEventListener("input", ()=>{
            let val = clampInt(inp.value);
            if (val > 3) val = 3;
            inp.value = val;
            updateViCounter();
          });
        }
        updateViCounter();

        $("addToCart").addEventListener("click", ()=>{
          const picked = viPicked();
          if (picked !== 7){
            setAlert("step2Alert", "Para agregar viandas al carrito ten√©s que seleccionar exactamente 7 (m√°x 3 de cada).");
            return;
          }

          const lines = [];
          for (let i=0;i<VIANDAS.length;i++){
            const q = clampInt($("v_"+i).value);
            if (q>0) lines.push(`- ${q}√ó ${VIANDAS[i]}`);
          }
          const notes = ($("viNotes").value || "").trim();
          const details = `Selecci√≥n:\n${lines.join("\n")}` + (notes ? `\nNotas: ${notes}` : "");

          cart.push({
            type:"viandas",
            name:"Viandas (pack de 7)",
            qty:1,
            unitPrice: PRICES.viandasPack,
            details
          });
          renderCart();

          for (let i=0;i<VIANDAS.length;i++) $("v_"+i).value = 0;
          $("viNotes").value = "";
          updateViCounter();
          setAlert("step2Alert", "Agregado al carrito ‚úÖ", true);
        });
      }
    }

    function validateStep2ForPay(){
      if (!cart.length){
        setAlert("step2Alert", "Agreg√° al menos un producto al carrito para ir a pagar.");
        return false;
      }
      return true;
    }

    // ===== Step 3 =====
    $("modoEntrega").addEventListener("change", ()=>{
      const v = $("modoEntrega").value;
      $("envioFields").style.display = (v==="envio") ? "block" : "none";
      setAlert("step3Alert","");
    });

    function validateStep3(){
      if (!cart.length){
        setAlert("step3Alert","El carrito est√° vac√≠o.");
        return false;
      }
      if ($("modoEntrega").value === "envio"){
        const dir = ($("direccion").value||"").trim();
        if (!dir){
          setAlert("step3Alert","Para env√≠o, complet√° la direcci√≥n.");
          return false;
        }
      }
      return true;
    }

    // ===== WhatsApp =====
    function buildMessage(){
      const total = cartTotal();
      const modo = $("modoEntrega").value;
      const pago = $("pago").value;
      const chk100k = $("chk100k").checked;

      let entregaBlock = "";
      if (modo === "retiro"){
        entregaBlock = `üö∂ Modalidad: Retiro (coordinamos por WhatsApp)`;
      } else {
        const dir = ($("direccion").value||"").trim() || "-";
        const mas3 = $("mas3km").value;
        entregaBlock = `üöö Modalidad: Env√≠o\nüìç Direcci√≥n: ${dir}\nüìè ¬øM√°s de 3 km desde Ciudadela?: ${mas3}`;
      }

      const lines = cart.map(it=>{
        const header = `- ${it.name} √ó ${it.qty} (${money(it.unitPrice)} c/u) = ${money(it.qty*it.unitPrice)}`;
        return it.details ? `${header}\n${it.details}` : header;
      });

      const msg =
`Hola! Quiero hacer un pedido en VaComoPi√±a ü•™

üßæ Carrito:
${lines.join("\n\n")}

${entregaBlock}

üí≥ Forma de pago: ${pago}

üí∞ Total estimado (sin env√≠o): ${money(total)}
${chk100k ? "üü¢ Marqu√© compra > $100.000 (env√≠o gratis a confirmar)\n" : ""}Aclaraci√≥n env√≠o:
- Gratis hasta 3 km
- $5.000 fuera de ese radio
- Gratis en compras mayores a $100.000 (a confirmar)`;

      return msg;
    }

    function sendWhatsApp(){
      const msg = buildMessage();
      const url = `https://wa.me/${WA}?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank");
    }

    // ===== Nav =====
    $("btnBack").addEventListener("click", ()=>{
      if (step === 2) showStep(1);
      else if (step === 3) showStep(2);
    });

    $("btnNext").addEventListener("click", ()=>{
      if (step === 1){
        if (!validateStep1()) return;
        resetDraftForProduct(draft.product);
        renderStep2();
        showStep(2);
        return;
      }
      if (step === 2){
        if (!validateStep2ForPay()) return;
        showStep(3);
        return;
      }
      if (step === 3){
        if (!validateStep3()) return;
        sendWhatsApp();
        return;
      }
    });

    function showStep(n){
      step = n;
      ["step1","step2","step3"].forEach((sid,i)=>{
        $(sid).classList.toggle("active", (i+1)===step);
      });

      if (step === 1){
        $("barMain").textContent = "Eleg√≠ un producto";
        $("barSub").textContent = "Despu√©s configur√°s cantidad y lo agreg√°s al carrito.";
        $("btnBack").classList.add("btnDisabled");
        $("btnBack").disabled = true;
        $("btnNext").textContent = "Siguiente";
        $("btnNext").classList.remove("btnDanger");
      }
      if (step === 2){
        $("barMain").textContent = cart.length ? "Pod√©s agregar m√°s productos" : "Configur√° el producto";
        $("barSub").textContent = "Agregalo al carrito. Luego pod√©s ir a pagar.";
        $("btnBack").classList.remove("btnDisabled");
        $("btnBack").disabled = false;
        $("btnNext").textContent = "Ir a pagar";
        $("btnNext").classList.remove("btnDanger");
      }
      if (step === 3){
        $("barMain").textContent = "Confirm√° y ped√≠";
        $("barSub").textContent = "Se abrir√° WhatsApp con el pedido armado.";
        $("btnBack").classList.remove("btnDisabled");
        $("btnBack").disabled = false;
        $("btnNext").textContent = "Pedir";
        $("btnNext").classList.add("btnDanger");
      }

      updateHeader();
    }

    function updateHeader(){
      const titles = {
        1: ["Paso 1: Eleg√≠ el producto", "Seleccion√° el tipo de producto para configurar cantidad y opciones."],
        2: ["Paso 2: Configur√° y agreg√° al carrito", "Eleg√≠ cantidad/opciones y agreg√° el producto al carrito."],
        3: ["Paso 3: Entrega y pago", "Eleg√≠ retiro/env√≠o y complet√° datos para enviar el pedido."]
      };
      $("stepTitle").textContent = titles[step][0];
      $("stepSub").textContent = titles[step][1];
      $("stepTag").textContent = `${step} de 3`;
      $("dot1").classList.toggle("on", step>=1);
      $("dot2").classList.toggle("on", step>=2);
      $("dot3").classList.toggle("on", step>=3);
    }

    // Init
    renderCart();
    updateHeader();
    $("envioFields").style.display = "none";
  </script>
</body>
</html>
